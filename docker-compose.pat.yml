services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    env_file:
      - .env
    environment:
      - OPENFACTORY_DB_PATH=/data/openfactory.db
      - OPENFACTORY_API_KEY_FILE=/run/secrets/openfactory_api_key
    user: "${HOST_UID}:${HOST_GID}"
    volumes:
      - /srv/odyssey/data:/data
    secrets:
      - source: openfactory_api_key
        target: openfactory_api_key
    command: ["uvicorn","api.main:app","--host","0.0.0.0","--port","8080"]
    network_mode: host
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:8080/health\", timeout=2)"]
      interval: 15s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    env_file:
      - .env
    environment:
      - OPENFACTORY_DB_PATH=/data/openfactory.db
      - OPENFACTORY_WORKSPACES_DIR=/workspaces
      - GITHUB_TOKEN_FILE=/run/secrets/github_pat
      - TEMPLATE_DIR=/app/templates/python-fastapi
      - BASE_BRANCH=main
    volumes:
      - /srv/odyssey/data:/data
      - /srv/odyssey/workspaces:/workspaces
      - ./templates:/app/templates:ro
    secrets:
      - source: github_pat
        target: github_pat
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    networks:
      - of_internal
      - of_egress

secrets:
  github_pat:
    file: /srv/odyssey/secrets/github_pat.txt
  openfactory_api_key:
    file: /srv/odyssey/secrets/openfactory_api_key.txt

networks:
  of_internal:
    internal: true
  of_egress: {}
